{% extends "base.html" %}

{% block content %}
<div class="row search-bar">
    <div class="col-md-10 col-lg-10">
        <input type="text" id="search" />
    </div>
    <div class="col-md-2 col-lg-2 btn-group">
        <button type="button" class="btn btn-default half-width-btn" id="search-btn">search</button>
        <button type="button" class="btn btn-default half-width-btn" id="new-btn">new</button>
    </div>
</div>

<div class="row">
    {% for post in posts %}
        {% include '_post.html' %}
    {% endfor %}
</div>

<script>
    var globals = globals || {}
    globals['searchUrl'] = "{{ url_for('index', _external=True) }}"
    globals['newPostUrl'] = "{{ url_for('new', _external=True) }}"
    globals['tags'] = {{ tags|tojson|safe }}

    $(function() {
        $('#search').select2({
            placeholder: 'Search tags',
            tags: true,
            tokenSeparators: [' ', ','],
            width: '100%'
        });

        $('#search').select2('val', globals['tags'])

        $('#search').on('change', function() {
            console.log('--changed')
        })

        var toggleMeta = function(showOrHide) {
            showOrHide = parseInt(showOrHide)
            if ( showOrHide ) {
                $('.meta-entry').css({
                    display: ''
                })
                $('.post-buttons').css({
                    display: ''
                })
                $('.entry').css({
                    border: '1px solid #ddd',
                    'margin-top': 20,
                    'padding': 20
                })
                $('.entry').addClass('well')
                $('.entry').addClass('well-sm')
            } else {
                $('.meta-entry').css({
                    display: 'none'
                })
                $('.post-buttons').css({
                    display: 'none'
                })
                $('.entry').css({
                    border: 'none',
                    'margin-top': 0,
                    'padding': 0
                })
                $('.well').each(function(idx, el) { $(el).removeClass('well') })
                $('.well').each(function(idx, el) { $(el).removeClass('well-sm') })
            }
        }

        var callback = function() {
            var showOrHide = sessionStorage.getItem('showOrHide') || 1
            showOrHide = 1 - showOrHide
            sessionStorage.setItem('showOrHide', showOrHide)
            toggleMeta(showOrHide)
        }
        Mousetrap.bind('alt+h', callback);

        toggleMeta(sessionStorage.getItem('showOrHide') || 1)

        $('[data-toggle="confirmation"]').confirmation({
            placement: 'top',
            onConfirm: function(event, element) {
                window.location = $(element).attr('href')
            }
        })

        $('#new-btn').click(function() {
            location.href = globals['newPostUrl'] + '?tags=' + encodeURIComponent($('#search').val())
        })

        $('.tag-buttons a').click(function(e) {
            var currentTags, $that, newTag

            e.preventDefault()
            currentTags = $('#search').select2('val')
            $that = $(this)
            newTag = $that.attr('aria-label')
            currentTags.push(newTag)
            $('#search').select2('val', currentTags)
        })

        Mousetrap.bind('alt+n', function() {
            $('#new-btn').trigger('click')
        })
        $('.search-bar input').each(function(idx, el) {
            Mousetrap(el).bind('alt+n', function() {
                $('#new-btn').trigger('click')
            })
        })

        $('#search-btn').click(function () {
            var tags = $('#search').select2('val').join(',')

            location.href = globals['searchUrl'] + '?tags=' + encodeURIComponent(tags)
        })
    })
</script>

{% endblock %}